# tsp
Deep RL + Pointer Nets for the Travelling Salesman Problem

## Installation
_This has been tested on Python 3.7, but will likely work for Python>=3.6_

1. Clone this repository

2. Install tsp requirements

    ```
    pip install -r requirements.txt
    ```

3. Install tsp (probably want to do so in editable mode)

    ```
    pip install -e .
    ```


## Solver Installations [Optional]

4. Install non-learned solver submodules

    ```
    git submodule update --init --recursive
    ```
    
    Then repeat steps 1-3 for each submodule in solvers/, also following specific instructions below...

- pyconcorde 
    - Ensure there's a C compiler (e.g. gcc) and make on your base environment PATH for building concorde:

        ```
        sudo apt update
        sudo apt install gcc make
        ```

    - Overwrite setup.py with our custom version to fix an install bug (urllib, used to download QSOPT, doesn't support HTTP 308 redirect; so we swap urllib with requests)

        ```
        cd solvers
        cp custom_pyconcorde_setup.py pyconcorde/setup.py
        ```
    
    - Install pyconcorde in editable mode ("-e" with pip), otherwise the wrapped concorde binaries may not correctly install (even if pyconcorde does)

        ```
        cd pyconcorde
        pip install -r requirements.txt
        pip install -e .
        ```

    - IFF the pyconcorde install fails due to "ModuleNotFoundError: No module named 'requests'" then run setup.py directly

        ```
        python setup.py install
        ```

## Train a Language-Style DRL TSP Solver

Let's train an agent on 10-city TSP using GPU 0 and use Visdom to log to /runs/10n_test:
```
python launch/train_model_agent.py 10n_test --nodes 10 --device 0
```
(If you wanted to avoid logging, simply remove the "10n_test" positional argument)

Batches of random 10-city TSP tours are generated live and the DRL agent learns to minimize tour length through trial and error.

As training is underway, let's plot performance metrics using Visdom. First, to launch the server run:
```
visdom
```

Then, in a seperate shell:
```
python plot.py live runs/10n_test
```

Metrics will be plotted live at **localhost:8097**. If you want to limit the number of metrics to plot, which can increase update speed, specify an arbitrary number of curves to plot at the end, for example:
```
python plot.py live runs/10n_test train_cost_avg critic_loss
```

This repository also supports training over a uniform random range of city sizes, varying problem difficulty and avoiding overfitting to one size. For example, to train between 5 and 20 cities:
```
python launch/train_model_agent.py 5to20n_test --node_range 5 20 --device 0
```

To see other capabilities, see remaining Python scripts in /launch. For example, train_model_supervised.py allows training a deep TSP solver via supervised imitation learning of the PyConcorde solver.

## Visualizing Tours with Matplotlib

**NOTE THIS STEP REQUIRES PYCONCORDE TO COMPUTE OPTIMAL TOURS IN TRACTABLE TIME**

We can draw tours generated by our DRL agent trained in the previous section and compare against the optimal solution using draw/agent_vs_oracle.py.

First update the configuration at the top of that file:
```
20    problem_size = 10
...
25    model_base = "10n_test/params_???.pt"  # replace ??? with your latest checkpoint in runs/10n_test
```

Then, to draw a sample of agent and oracle tours side by side:
```
python draw/agent_vs_oracle.py
```
(Figure is saved to draw/saved after closing matplotlib window)

This repository also supports drawing individual agent, oracle, and random tours. See draw/single_tour.py.

## Unit Testing
To run unit tests:
```
python test/run.py
```

If the PyConcorde solver is installed, one test results in "ValueError: I/O operation on closed file" due to the I/O bug listed in the section below. This only occurs when the solver is run through unittest.

Note pytest and other testing module scripts will not work because Logger must first be initialized.

## TODOs
Core
- Distributed GPU training
- Non-iterative decoder-only policy

Auxiliary
- Pretty stdout printing
- Naive external solver (e.g. nearest insertion)
- Plotting optimality gaps, running averages, and horizontal bounds with plot.py (Visdom)
- Undiscounted GAE for A2C

Bugs
- IO bug when using unittest with bridge.c_stderr_redirector (need PyConcorde to reproduce)
- Bugs with parallel ConcordeSolver use (redirectors appear to not be thread-safe)
    - Add parallel support in launch/gen_supervised_dataset.py after fixing this
- "inf" points in line plot result in graph not being plotted by Visdom (can replace with "nan" which displays as hole)

